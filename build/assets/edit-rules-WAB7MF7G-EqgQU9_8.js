import{R as E}from"./chunk-YQP2QO7I-Y0GItYN2.js";import"./chunk-UY4EBCIZ-BkMu1ycI.js";import{i as p,w as F,u as v,cc as q,j as r,H as S,c7 as A,cd as B,ce as C,cf as z,r as D}from"./index-DQ7iaOIo.js";import{a as m,u as H}from"./chunk-RLLZZQKN-CuYY48Je.js";import{u as U}from"./chunk-C7RYT3S3-DvWl1ixb.js";import{t as L}from"./zod-DqtdDTUb.js";import{z as s}from"./index-yuYasa5Y.js";import{B as R}from"./label-DsyTUQgE.js";import"./x-mark-mini-DjxzaqmQ.js";import"./select-CYzOnLAx.js";import"./index-CIxKSFC7.js";import"./triangles-mini-BMU6OfpM.js";import"./plus-mini-DfhjBeEB.js";import"./prompt-BKfKBHyN.js";var M=s.object({type:s.string().optional(),rules:s.array(s.object({id:s.string().optional(),attribute:s.string().min(1,{message:p.t("promotions.form.required")}),operator:s.string().min(1,{message:p.t("promotions.form.required")}),values:s.union([s.number().min(1,{message:p.t("promotions.form.required")}),s.string().min(1,{message:p.t("promotions.form.required")}),s.array(s.string()).min(1,{message:p.t("promotions.form.required")})]),required:s.boolean().optional(),disguised:s.boolean().optional(),field_type:s.string().optional()}))}),N=({promotion:e,ruleType:f,handleSubmit:l,isSubmitting:o})=>{const{t:d}=v(),[n,i]=D.useState([]),u=U({defaultValues:{rules:[],type:e.type},resolver:L(M)}),c=u.handleSubmit(l(n));return r.jsx(m.Form,{form:u,children:r.jsxs("form",{onSubmit:c,className:"flex h-full flex-col",children:[r.jsx(m.Body,{children:r.jsx(E,{form:u,ruleType:f,setRulesToRemove:i,rulesToRemove:n,promotion:e})}),r.jsx(m.Footer,{children:r.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[r.jsx(m.Close,{asChild:!0,children:r.jsx(R,{size:"small",variant:"secondary",disabled:o,children:d("actions.cancel")})}),r.jsx(R,{size:"small",type:"submit",isLoading:o,children:d("actions.save")})]})})]})})},V=e=>e.field_type==="number"?parseInt(e.values):e.values,$=({promotion:e,rules:f,ruleType:l})=>{const{handleSuccess:o}=H(),{mutateAsync:d}=A(e.id),{mutateAsync:n}=B(e.id,l),{mutateAsync:i}=C(e.id,l),{mutateAsync:u,isPending:c}=z(e.id,l),b=a=>async function(g){const h={},{rules:x=[]}=g,w=x.filter(t=>t.disguised),_=(a==null?void 0:a.filter(t=>t.disguised))||[];for(const t of w)h[t.attribute]=V(t);for(const t of _)h[t.attribute]=null;const y=x.filter(t=>!t.disguised),j=y.filter(t=>!("id"in t)),P=y.filter(t=>typeof t.id=="string");Object.keys(h).length&&await d({application_method:h}),j.length&&await n({rules:j.map(t=>({attribute:t.attribute,operator:t.operator,values:t.values}))}),a!=null&&a.length&&await i({rule_ids:a.map(t=>t.id).filter(Boolean)}),P.length&&await u({rules:P.map(t=>({id:t.id,attribute:t.attribute,operator:t.operator,values:t.values}))}),o()};return r.jsx(N,{promotion:e,rules:f,ruleType:l,handleSubmit:b,isSubmitting:c})},st=()=>{var a,g;const e=F();if(!["rules","buy-rules","target-rules"].includes(e.ruleType))throw"invalid page";const{t:l}=v(),o=e.ruleType,d=e.id,n=[],{promotion:i,isPending:u,isError:c,error:b}=q(d);if(i&&(o==="rules"?n.push(...i.rules||[]):o==="target-rules"?n.push(...((a=i==null?void 0:i.application_method)==null?void 0:a.target_rules)||[]):o==="buy-rules"&&n.push(...((g=i.application_method)==null?void 0:g.buy_rules)||[])),c)throw b;return r.jsxs(m,{children:[r.jsx(m.Header,{children:r.jsx(S,{children:l(`promotions.edit.${o}.title`)})}),!u&&i&&r.jsx($,{promotion:i,rules:n,ruleType:o})]})};export{st as Component};
