import{E as R,U as O}from"./chunk-2SYNWDTT-DRR2kaiH.js";import"./chunk-Y2QXUTMB-BX8XhJpg.js";import{r as x,w as W,j as e,d as H,u as z,s as K,L,a as q,n as S,M as J,T as A,y as B,g as k,J as X,G as Y,S as $}from"./index-DQ7iaOIo.js";import{R as w,u as Q}from"./chunk-RLLZZQKN-CuYY48Je.js";import{u as Z,b as ee}from"./chunk-C7RYT3S3-DvWl1ixb.js";import{f as se,g as U}from"./chunk-4N7PLYUW-DRfoew5M.js";import{t as te}from"./zod-DqtdDTUb.js";import{T as ie}from"./trash-AHlgA58B.js";import{T as F}from"./thumbnail-badge-mN0_ItPW.js";import{T as ae}from"./triangle-left-mini-o3U9ykef.js";import{A as re}from"./index-DurlSV0o.js";import{m as ne}from"./motion-DA5tZ6sm.js";import{u as le}from"./use-prompt-DSUtE_64.js";import{B as N}from"./label-DsyTUQgE.js";import{C as y}from"./command-bar-B4tNt0in.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./chunk-TYTNUPXB-GDIjg0Ig.js";import"./index-yuYasa5Y.js";import"./prompt-BKfKBHyN.js";import"./chunk-DMYZ6SLX-CvGU_oYL.js";import"./index-T2cn0UOM.js";var oe=({media:i,selection:s,onCheckedChange:a})=>e.jsx("div",{className:"bg-ui-bg-subtle size-full overflow-auto",children:e.jsx("div",{className:"grid h-fit auto-rows-auto grid-cols-4 gap-6 p-6",children:i.map(t=>e.jsx(de,{onCheckedChange:a(t.id),checked:!!s[t.id],media:t},t.field_id))})}),de=({media:i,checked:s,onCheckedChange:a})=>{const[t,n]=x.useState(!0),{t:c}=z(),u=x.useCallback(()=>{a(!s)},[s,a]);return e.jsxs("button",{type:"button",onClick:u,className:"shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full overflow-hidden rounded-lg outline-none",children:[i.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(B,{content:c("products.media.thumbnailTooltip"),children:e.jsx(F,{})})}),e.jsx("div",{className:k("transition-fg absolute right-2 top-2 opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 group-focus:opacity-100",{"opacity-100":s}),children:e.jsx("div",{className:k("group relative inline-flex h-4 w-4 items-center justify-center outline-none "),children:e.jsx("div",{className:k("text-ui-fg-on-inverted bg-ui-bg-component shadow-borders-base [&_path]:shadow-details-contrast-on-bg-interactive group-disabled:text-ui-fg-disabled group-disabled:!bg-ui-bg-disabled group-disabled:!shadow-borders-base transition-fg h-[14px] w-[14px] rounded-[3px]",{"bg-ui-bg-interactive group-hover:bg-ui-bg-interactive shadow-borders-interactive-with-shadow":s}),children:s&&e.jsx("div",{className:"absolute inset-0",children:e.jsx(Y,{})})})})}),e.jsx(re,{children:t&&e.jsx(ne.div,{initial:{opacity:1},animate:{opacity:1},exit:{opacity:0,transition:{duration:.5}},className:"bg-ui-bg-subtle-hover absolute inset-0 flex items-center justify-center",children:e.jsx($,{className:"text-ui-fg-subtle animate-spin"})})}),e.jsx("img",{src:i.url,onLoad:()=>n(!1),alt:"",className:"size-full object-cover object-center"})]})},ce=({product:i})=>{const[s,a]=x.useState({}),{t}=z(),{handleSuccess:n}=Q(),c=Z({defaultValues:{media:ue(i.images,i.thumbnail)},resolver:te(R)}),{fields:u,append:r,remove:o,update:p}=ee({name:"media",control:c.control,keyName:"field_id"}),{mutateAsync:m,isPending:j}=U(i.id),I=c.handleSubmit(async({media:f})=>{var E;const d=f.map((h,T)=>({file:h.file,index:T})).filter(h=>!!h.file);let b=[];if(d.length){const{files:h}=await K.admin.upload.create({files:d.map(T=>T.file)}).catch(()=>(c.setError("media",{type:"invalid_file",message:t("products.media.failedToUpload")}),{files:[]}));b=h}const g=f.map((h,T)=>{var _;const V=d.findIndex(G=>G.index===T);return V>-1?{...h,url:(_=b[V])==null?void 0:_.url}:h}),D=(E=g.find(h=>h.isThumbnail))==null?void 0:E.url;await m({images:g.map(h=>({url:h.url})),thumbnail:D||""},{onSuccess:()=>{n()}})}),M=x.useCallback(f=>d=>{if(d)a(b=>({...b,[f]:!0}));else{const{[f]:b,...g}=s;a(g)}},[s]),C=()=>{const d=Object.keys(s).map(b=>u.findIndex(g=>g.id===b));o(d),a({})},l=()=>{const f=Object.keys(s);if(!f.length)return;const d=u.findIndex(g=>g.isThumbnail);d>-1&&p(d,{...u[d],isThumbnail:!1});const b=u.findIndex(g=>g.id===f[0]);p(b,{...u[b],isThumbnail:!0}),a({})},v=Object.keys(s).length;return e.jsx(w.Form,{blockSearch:!0,form:c,children:e.jsxs("form",{className:"flex size-full flex-col overflow-hidden",onSubmit:I,children:[e.jsx(w.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(N,{variant:"secondary",size:"small",children:t("actions.cancel")})}),e.jsx(N,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(L,{to:{pathname:".",search:void 0},children:t("products.media.galleryLabel")})}),e.jsx(N,{size:"small",type:"submit",isLoading:j,children:t("actions.save")})]})}),e.jsx(w.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx(oe,{media:u,onCheckedChange:M,selection:s}),e.jsx("div",{className:"bg-ui-bg-base border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx(O,{form:c,append:r})})]})}),e.jsx(y,{open:!!v,children:e.jsxs(y.Bar,{children:[e.jsx(y.Value,{children:t("general.countSelected",{count:v})}),e.jsx(y.Seperator,{}),v===1&&e.jsxs(x.Fragment,{children:[e.jsx(y.Command,{action:l,label:t("products.media.makeThumbnail"),shortcut:"t"}),e.jsx(y.Seperator,{})]}),e.jsx(y.Command,{action:C,label:t("actions.delete"),shortcut:"d"})]})})]})})},ue=(i,s)=>{const a=(i==null?void 0:i.map(t=>({id:t.id,url:t.url,isThumbnail:t.url===s,file:null})))||[];if(s&&!a.some(t=>t.url===s)){const t=Math.random().toString(36).substring(7);a.unshift({id:t,url:s,isThumbnail:!0,file:null})}return a},me=({product:i})=>{const{state:s}=q(),[a,t]=x.useState((s==null?void 0:s.curr)||0),{t:n}=z(),c=le(),{mutateAsync:u,isLoading:r}=U(i.id),o=xe(i.images,i.thumbnail),p=x.useCallback(()=>{r||t(l=>(l+1)%o.length)},[o,r]),m=x.useCallback(()=>{r||t(l=>(l-1+o.length)%o.length)},[o,r]),j=x.useCallback(l=>{r||t(l)},[r]),I=()=>{if(r)return;const l=document.createElement("a");l.href=o[a].url,l.download="image",l.target="_blank",l.click()},M=async()=>{const l=o[a];if(!await c({title:n("general.areYouSure"),description:l.isThumbnail?n("products.media.deleteWarningWithThumbnail",{count:1}):n("products.media.deleteWarning",{count:1}),confirmText:n("actions.delete"),cancelText:n("actions.cancel")}))return;const f=i.images.filter(d=>d.id!==l.id).map(d=>d.url);a===o.length-1&&t(d=>d-1),await u({images:f,thumbnail:l.isThumbnail?"":void 0})};x.useEffect(()=>{const l=v=>{v.key==="ArrowRight"?p():v.key==="ArrowLeft"&&m()};return document.addEventListener("keydown",l),()=>{document.removeEventListener("keydown",l)}},[p,m]);const C=!o.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(w.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(S,{size:"small",type:"button",onClick:M,disabled:C,children:[e.jsx(ie,{}),e.jsx("span",{className:"sr-only",children:n("products.media.deleteImageLabel")})]}),e.jsxs(S,{size:"small",type:"button",onClick:I,disabled:C,children:[e.jsx(J,{}),e.jsx("span",{className:"sr-only",children:n("products.media.downloadImageLabel")})]}),e.jsx(N,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(L,{to:{pathname:".",search:"view=edit"},children:n("actions.edit")})})]})}),e.jsxs(w.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(he,{curr:a,media:o}),e.jsx(fe,{curr:a,media:o,prev:m,next:p,goTo:j})]})]})},he=({media:i,curr:s})=>{const{t:a}=z();return i.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle flex size-full flex-col items-center justify-center gap-y-4 pb-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(A,{size:"small",leading:"compact",weight:"plus",className:"text-ui-fg-subtle",children:a("products.media.emptyState.header")}),e.jsx(A,{size:"small",className:"text-ui-fg-muted",children:a("products.media.emptyState.description")})]}),e.jsx(N,{size:"small",variant:"secondary",asChild:!0,children:e.jsx(L,{to:"?view=edit",children:a("products.media.emptyState.action")})})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative h-full w-fit",children:[i[s].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(B,{content:a("products.media.thumbnailTooltip"),children:e.jsx(F,{})})}),e.jsx("img",{src:i[s].url,alt:"",className:"object-fit shadow-elevation-card-rest size-full rounded-xl object-contain"})]})})})},P=8,fe=({media:i,curr:s,prev:a,next:t,goTo:n})=>{if(!i.length)return null;const u=((r,o)=>{if(r.length<=P)return r;const p=Math.floor(P/2),m=(o-p+r.length)%r.length,j=(m+P)%r.length;return j<m?[...r.slice(m),...r.slice(0,j)]:r.slice(m,j)})(i,s);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(S,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:a,children:e.jsx(ae,{})}),e.jsx("div",{className:"flex items-center gap-x-2",children:u.map(r=>{const o=r.id===i[s].id,p=i.findIndex(m=>m.id===r.id);return e.jsx("button",{type:"button",onClick:()=>n(p),className:k("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":o}),children:e.jsx("img",{src:r.url,alt:"",className:"size-full object-cover"})},r.id)})}),e.jsx(S,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:t,children:e.jsx(X,{})})]})},xe=(i,s)=>{const a=(i==null?void 0:i.map(t=>({id:t.id,url:t.url,isThumbnail:t.url===s})))||[];return s&&!a.some(t=>t.isThumbnail)&&a.unshift({id:"thumbnail_only",url:s,isThumbnail:!0}),a},pe=x.createContext(null),be=i=>i.get("view")==="edit"?"edit":"gallery",ge=({product:i})=>{const[s,a]=H(),t=be(s),n=c=>()=>{a({view:c})};return e.jsx(pe.Provider,{value:{goToGallery:n("gallery"),goToEdit:n("edit")},children:je(t,i)})},je=(i,s)=>{switch(i){case"gallery":return e.jsx(me,{product:s});case"edit":return e.jsx(ce,{product:s})}},Ge=()=>{const{id:i}=W(),{product:s,isLoading:a,isError:t,error:n}=se(i),c=!a&&s;if(t)throw n;return e.jsx(w,{children:c&&e.jsx(ge,{product:s})})};export{Ge as Component};
