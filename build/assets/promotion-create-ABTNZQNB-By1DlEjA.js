import{D as ce}from"./chunk-YRY2CZ6I-B_uqCOEO.js";import{A as de}from"./chunk-VVHEE5AR-D3NjRH_E.js";import{R as D}from"./chunk-YQP2QO7I-Y0GItYN2.js";import{C as me,d as Q}from"./chunk-D4TZDBTG-BZ0WY1fZ.js";import{g as pe}from"./chunk-MWVM4TYO-bKUcYSnf.js";import{u as ue,a as g,F as o}from"./chunk-C7RYT3S3-DvWl1ixb.js";import{j as e,r as x,u as he,c5 as fe,t as q,c6 as ge,H as xe,B as ye,g as u,I as U,T as I,D as T}from"./index-DQ7iaOIo.js";import"./chunk-UY4EBCIZ-BkMu1ycI.js";import{R as b,u as _e}from"./chunk-RLLZZQKN-CuYY48Je.js";import{t as je}from"./zod-DqtdDTUb.js";import{z as i}from"./index-yuYasa5Y.js";import{T as B}from"./Trans-LG4CmYWt.js";import{P as h}from"./progress-tabs-nihPaPnN.js";import{B as S}from"./label-DsyTUQgE.js";import{R as d}from"./radio-group-CqMTuXTE.js";import{A as be}from"./alert-BDVUsyGc.js";import{C as ve}from"./currency-input-YdrMuETU.js";import"./index.esm-C23H4hs_.js";import"./chunk-JQ6CQ3T5-9-cLGH8g.js";import"./textarea-BWm6luAN.js";import"./date-picker-BsdoIRhX.js";import"./clsx-B-dksMZM.js";import"./popover-C1ro1ubo.js";import"./index-T2cn0UOM.js";import"./x-mark-mini-DjxzaqmQ.js";import"./triangle-left-mini-o3U9ykef.js";import"./select-CYzOnLAx.js";import"./index-CIxKSFC7.js";import"./triangles-mini-BMU6OfpM.js";import"./plus-mini-DfhjBeEB.js";import"./prompt-BKfKBHyN.js";var M=i.array(i.object({id:i.string().optional(),attribute:i.string().min(1,{message:"Required field"}),operator:i.string().min(1,{message:"Required field"}),values:i.union([i.number().min(1,{message:"Required field"}),i.string().min(1,{message:"Required field"}),i.array(i.string()).min(1,{message:"Required field"})]),required:i.boolean().optional(),disguised:i.boolean().optional(),field_type:i.string().optional()})),Ce=i.object({template_id:i.string().optional(),campaign_id:i.string().optional(),campaign_choice:i.enum(["none","existing","new"]).optional(),is_automatic:i.string().toLowerCase(),code:i.string().min(1),type:i.enum(["buyget","standard"]),rules:M,application_method:i.object({allocation:i.enum(["each","across"]),value:i.number().min(0),currency_code:i.string().optional(),max_quantity:i.number().optional().nullable(),target_rules:M,buy_rules:M,type:i.enum(["fixed","percentage"]),target_type:i.enum(["order","shipping_methods","items"])}),campaign:me.optional()}).refine(f=>f.application_method.allocation==="across"?!0:f.application_method.allocation==="each"&&typeof f.application_method.max_quantity=="number",{path:["application_method.max_quantity"],message:"required field"}),j=["type","application_method.type","application_method.allocation"],P=[{id:"amount_off_products",type:"standard",title:"Amount off products",description:"Discount specific products or collection of products",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"each",target_type:"items",type:"fixed"}}},{id:"amount_off_order",type:"standard",title:"Amount off order",description:"Discounts the total order amount",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"across",target_type:"order",type:"fixed"}}},{id:"percentage_off_product",type:"standard",title:"Percentage off product",description:"Discounts a percentage off selected products",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"each",target_type:"items",type:"percentage"}}},{id:"percentage_off_order",type:"standard",title:"Percentage off order",description:"Discounts a percentage of the total order amount",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"across",target_type:"order",type:"percentage"}}},{id:"buy_get",type:"buy_get",title:"Buy X Get Y",description:"Buy X product(s), get Y product(s)",hiddenFields:[...j,"application_method.value"],defaults:{is_automatic:"false",type:"buyget",application_method:{type:"percentage",value:100,apply_to_quantity:1,max_quantity:1}}}],W={campaign_id:void 0,template_id:P[0].id,campaign_choice:"none",is_automatic:"false",code:"",type:"standard",rules:[],application_method:{allocation:"each",type:"fixed",target_type:"items",max_quantity:1,target_rules:[],buy_rules:[]},campaign:void 0},Ne=()=>{var z,H,K,O;const[f,y]=x.useState("type"),[E,N]=x.useState(!1),{t:s}=he(),{handleSuccess:J}=_e(),a=ue({defaultValues:W,resolver:je(Ce)}),{mutateAsync:Z}=fe(),ee=a.handleSubmit(async t=>{const{campaign_choice:n,is_automatic:l,template_id:m,application_method:p,rules:G,...re}=t,{target_rules:X=[],buy_rules:Y=[],...ne}=p,le=[...X.filter(c=>!!c.disguised),...Y.filter(c=>!!c.disguised),...G.filter(c=>!!c.disguised)],$={};for(const c of le)$[c.attribute]=c.field_type==="number"?parseInt(c.values):c.values;const R=c=>c.filter(_=>!_.disguised).map(_=>({operator:_.operator,attribute:_.attribute,values:_.values}));Z({...re,rules:R(G),application_method:{...ne,...$,target_rules:R(X),buy_rules:R(Y)},is_automatic:l==="true"},{onSuccess:({promotion:c})=>{q.success(s("promotions.toasts.promotionCreateSuccess",{code:c.code})),J()},onError:c=>{q.error(c.message)}})},async t=>{const{campaign:n,...l}=t||{};!!Object.keys(l||{}).length&&q.error(s("promotions.errors.promotionTabError"))}),te=async()=>{switch(f){case"type":y("promotion");break;case"promotion":await a.trigger()&&y("campaign");break}},oe=t=>{switch(t){case"type":N(!1),y(t);break;case"promotion":N(!1),y(t);break;case"campaign":N(!1),y(t);break}},F=g({control:a.control,name:"template_id"}),r=x.useMemo(()=>{const t=P.find(n=>n.id===F);if(t){a.reset({...W,template_id:F});for(const[n,l]of Object.entries(t.defaults))if(typeof l=="object")for(const[m,p]of Object.entries(l))a.setValue(`application_method.${m}`,p);else a.setValue(n,l);return t}},[F]),v=g({control:a.control,name:"application_method.type"})==="fixed",w=g({control:a.control,name:"application_method.allocation"});x.useEffect(()=>{w==="across"&&a.setValue("application_method.max_quantity",null)},[w]);const V=g({control:a.control,name:"type"})==="standard",ae=g({control:a.control,name:"application_method.target_type"})==="order",k=a.getValues();let A={};v&&k.application_method.currency_code&&(A={budget:{currency_code:k.application_method.currency_code}});const{campaigns:se}=ge(A),ie=x.useMemo(()=>E?"completed":"not-started",[E]),C=g({control:a.control,name:"campaign_choice"});x.useEffect(()=>{var n,l;const t=a.getValues();C!=="existing"&&a.setValue("campaign_id",void 0),C!=="new"&&a.setValue("campaign",void 0),C==="new"&&(!t.campaign||!((l=(n=t.campaign)==null?void 0:n.budget)!=null&&l.type))&&a.setValue("campaign",{...Q,budget:{...Q.budget,currency_code:t.application_method.currency_code}})},[C]);const L=g({control:a.control,name:"rules"}).find(t=>t.attribute==="currency_code");if(L){const n=a.getValues().application_method.currency_code,l=L.values;!Array.isArray(l)&&n!==l&&a.setValue("application_method.currency_code",l)}return e.jsx(b.Form,{form:a,children:e.jsx("form",{className:"flex h-full flex-col overflow-scroll",onSubmit:ee,children:e.jsxs(h,{value:f,onValueChange:t=>oe(t),children:[e.jsx(b.Header,{children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-x-4",children:[e.jsx("div",{className:"-my-2 w-full max-w-[400px] border-l",children:e.jsxs(h.List,{className:"grid w-full grid-cols-3",children:[e.jsx(h.Trigger,{className:"w-full",value:"type",status:ie,children:s("promotions.tabs.template")}),e.jsx(h.Trigger,{className:"w-full",value:"promotion",children:s("promotions.tabs.details")}),e.jsx(h.Trigger,{className:"w-full",value:"campaign",children:s("promotions.tabs.campaign")})]})}),e.jsxs("div",{className:"flex items-center gap-x-2",children:[e.jsx(b.Close,{asChild:!0,children:e.jsx(S,{variant:"secondary",size:"small",children:s("actions.cancel")})}),f==="campaign"?e.jsx(S,{type:"submit",size:"small",isLoading:!1,children:s("actions.save")},"save-btn"):e.jsx(S,{type:"button",onClick:te,size:"small",children:s("actions.continue")},"continue-btn")]})]})}),e.jsxs(b.Body,{className:"mx-auto my-20 w-[800px]",children:[e.jsx(h.Content,{value:"type",children:e.jsx(o.Field,{control:a.control,name:"template_id",render:({field:t})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:s("promotions.fields.type")}),e.jsx(o.Control,{children:e.jsx(d,{className:"flex-col gap-y-3",...t,onValueChange:t.onChange,children:P.map(n=>e.jsx(d.ChoiceBox,{value:n.id,label:n.title,description:n.description},n.id))},"template_id")}),e.jsx(o.ErrorMessage,{})]})})}),e.jsxs(h.Content,{value:"promotion",className:"flex flex-1 flex-col gap-8",children:[e.jsxs(xe,{level:"h1",className:"text-fg-base",children:[s("promotions.sections.details"),(r==null?void 0:r.title)&&e.jsx(ye,{className:"ml-2 align-middle",color:"grey",size:"2xsmall",rounded:"full",children:r==null?void 0:r.title})]}),a.formState.errors.root&&e.jsx(be,{variant:"error",dismissible:!1,className:"text-balance",children:a.formState.errors.root.message}),e.jsx(o.Field,{control:a.control,name:"is_automatic",render:({field:t})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:"Method"}),e.jsx(o.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,value:t.value,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"false",label:s("promotions.form.method.code.title"),description:s("promotions.form.method.code.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"true",label:s("promotions.form.method.automatic.title"),description:s("promotions.form.method.automatic.description"),className:u("basis-1/2")})]})}),e.jsx(o.ErrorMessage,{})]})}),e.jsx("div",{className:"flex gap-y-4",children:e.jsx(o.Field,{control:a.control,name:"code",render:({field:t})=>e.jsxs(o.Item,{className:"basis-1/2",children:[e.jsx(o.Label,{children:s("promotions.form.code.title")}),e.jsx(o.Control,{children:e.jsx(U,{...t,placeholder:"SUMMER15"})}),e.jsx(I,{size:"small",leading:"compact",className:"text-ui-fg-subtle",children:e.jsx(B,{t:s,i18nKey:"promotions.form.code.description",components:[e.jsx("br",{},"break")]})})]})})}),!((z=r==null?void 0:r.hiddenFields)!=null&&z.includes("type"))&&e.jsx(o.Field,{control:a.control,name:"type",render:({field:t})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:s("promotions.fields.type")}),e.jsx(o.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"standard",label:s("promotions.form.type.standard.title"),description:s("promotions.form.type.standard.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"buyget",label:s("promotions.form.type.buyget.title"),description:s("promotions.form.type.buyget.description"),className:u("basis-1/2")})]})}),e.jsx(o.ErrorMessage,{})]})}),e.jsx(T,{}),e.jsx(D,{form:a,ruleType:"rules"}),e.jsx(T,{}),!((H=r==null?void 0:r.hiddenFields)!=null&&H.includes("application_method.type"))&&e.jsx(o.Field,{control:a.control,name:"application_method.type",render:({field:t})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:s("promotions.fields.value_type")}),e.jsx(o.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"fixed",label:s("promotions.form.value_type.fixed.title"),description:s("promotions.form.value_type.fixed.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"percentage",label:s("promotions.form.value_type.percentage.title"),description:s("promotions.form.value_type.percentage.description"),className:u("basis-1/2")})]})}),e.jsx(o.ErrorMessage,{})]})}),e.jsxs("div",{className:"flex gap-x-2 gap-y-4",children:[!((K=r==null?void 0:r.hiddenFields)!=null&&K.includes("application_method.value"))&&e.jsx(o.Field,{control:a.control,name:"application_method.value",render:({field:{onChange:t,value:n,...l}})=>{const m=a.getValues().application_method.currency_code;return e.jsxs(o.Item,{className:"basis-1/2",children:[e.jsx(o.Label,{tooltip:m||!v?void 0:s("promotions.fields.amount.tooltip"),children:s("promotions.form.value.title")}),e.jsx(o.Control,{children:v?e.jsx(ve,{...l,min:0,onValueChange:p=>{t(p?parseInt(p):"")},code:m,symbol:m?pe(m):"",value:n,disabled:!m}):e.jsx(ce,{className:"text-right",min:0,max:100,...l,value:n,onChange:p=>{t(p.target.value===""?null:parseInt(p.target.value))}},"amount")}),e.jsx(I,{size:"small",leading:"compact",className:"text-ui-fg-subtle",children:e.jsx(B,{t:s,i18nKey:v?"promotions.form.value_type.fixed.description":"promotions.form.value_type.percentage.description",components:[e.jsx("br",{},"break")]})}),e.jsx(o.ErrorMessage,{})]})}}),V&&w==="each"&&e.jsx(o.Field,{control:a.control,name:"application_method.max_quantity",render:({field:t})=>e.jsxs(o.Item,{className:"basis-1/2",children:[e.jsx(o.Label,{children:s("promotions.form.max_quantity.title")}),e.jsx(o.Control,{children:e.jsx(U,{...a.register("application_method.max_quantity",{valueAsNumber:!0}),type:"number",min:1,placeholder:"3"})}),e.jsx(I,{size:"small",leading:"compact",className:"text-ui-fg-subtle",children:e.jsx(B,{t:s,i18nKey:"promotions.form.max_quantity.description",components:[e.jsx("br",{},"break")]})})]})})]}),V&&!((O=r==null?void 0:r.hiddenFields)!=null&&O.includes("application_method.allocation"))&&e.jsx(o.Field,{control:a.control,name:"application_method.allocation",render:({field:t})=>e.jsxs(o.Item,{children:[e.jsx(o.Label,{children:s("promotions.fields.allocation")}),e.jsx(o.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"each",label:s("promotions.form.allocation.each.title"),description:s("promotions.form.allocation.each.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"across",label:s("promotions.form.allocation.across.title"),description:s("promotions.form.allocation.across.description"),className:u("basis-1/2")})]})}),e.jsx(o.ErrorMessage,{})]})}),!V&&e.jsx(e.Fragment,{children:e.jsx(D,{form:a,ruleType:"buy-rules",scope:"application_method.buy_rules"})}),!ae&&e.jsxs(e.Fragment,{children:[e.jsx(T,{}),e.jsx(D,{form:a,ruleType:"target-rules",scope:"application_method.target_rules"})]})]}),e.jsx(h.Content,{value:"campaign",className:"flex flex-col items-center",children:e.jsx(de,{form:a,campaigns:se||[]})})]})]})})})},rt=()=>e.jsx(b,{children:e.jsx(Ne,{})});export{rt as Component};
