import{g}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{M as S}from"./chunk-LHJ6JQGA-DbSCtxtF.js";import{T as E}from"./chunk-PHMALPVO-BXYfPvrg.js";import{w as q,a3 as M,j as e,u as I,ad as T,r as N,t as w,T as C,A as k,I as A}from"./index-DQ7iaOIo.js";import{a as L,b as O}from"./chunk-3UMDCRM2-NSGJIubw.js";import{R as y,u as V}from"./chunk-RLLZZQKN-CuYY48Je.js";import{u as $,a as Q,F as l}from"./chunk-C7RYT3S3-DvWl1ixb.js";import{o as R}from"./chunk-4N7PLYUW-DRfoew5M.js";import{t as z}from"./zod-DqtdDTUb.js";import{z as h}from"./index-yuYasa5Y.js";import{T as H}from"./trash-AHlgA58B.js";import{B as F}from"./label-DsyTUQgE.js";import{S as v}from"./select-CYzOnLAx.js";import{A as B}from"./alert-BDVUsyGc.js";import{S as P}from"./switch-CHhgpYt_.js";import"./chunk-FSMQADBD-DQ6u7KYm.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-P3UUX2T6-OlAXa1VC.js";import"./prompt-BKfKBHyN.js";import"./chunk-DMYZ6SLX-CvGU_oYL.js";import"./index-CIxKSFC7.js";import"./triangles-mini-BMU6OfpM.js";import"./x-mark-mini-DjxzaqmQ.js";var D=h.object({quantity:h.record(h.string(),h.number()),location_id:h.string(),send_notification:h.boolean().optional()});function G({item:r,currencyCode:i,form:m,locationId:u,onItemRemove:j}){const{t:a}=I(),{variant:d}=R(r.variant.product_id,r.variant_id,{fields:"*inventory,*inventory.location_levels"}),n=!!(d!=null&&d.inventory.length),{availableQuantity:o,inStockQuantity:_}=N.useMemo(()=>{var t,c;if(!d||!u)return{};const{inventory:x}=d,s=(c=(t=x[0])==null?void 0:t.location_levels)==null?void 0:c.find(p=>p.location_id===u);return s?{availableQuantity:s.available_quantity,inStockQuantity:s.stocked_quantity}:{}},[d,u]),b=0,f=Math.min(g(r),o||Number.MAX_SAFE_INTEGER);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex gap-x-2 border-b p-3 text-sm",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-x-3",children:[e.jsx(E,{src:r.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(C,{className:"txt-small",as:"span",weight:"plus",children:r.title}),r.variant.sku&&e.jsxs("span",{children:["(",r.variant.sku,")"]})]}),e.jsx(C,{as:"div",className:"text-ui-fg-subtle txt-small",children:r.variant.title})]})]}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0 flex-col items-center",children:[e.jsx(S,{className:"justify-end",currencyCode:i,amount:r.total}),n&&e.jsxs("span",{children:[a("orders.fulfillment.available"),": ",o||"N/A"," ","Â· ",a("orders.fulfillment.inStock"),": ",_||"N/A"]})]}),e.jsx("div",{className:"flex items-center",children:e.jsx(k,{groups:[{actions:[{label:a("actions.remove"),icon:e.jsx(H,{}),onClick:()=>j(r.id)}]}]})})]}),e.jsx("div",{className:"block p-3 text-sm",children:e.jsxs("div",{className:"flex-1",children:[e.jsx(C,{weight:"plus",className:"txt-small mb-2",children:a("fields.quantity")}),e.jsx(l.Field,{control:m.control,name:`quantity.${r.id}`,rules:{required:!0,min:b,max:f},render:({field:x})=>e.jsxs(l.Item,{children:[e.jsx(l.Control,{children:e.jsx(A,{className:"bg-ui-bg-base txt-small w-full rounded-lg",type:"number",...x,onChange:s=>{const t=s.target.value===""?null:Number(s.target.value);x.onChange(t),isNaN(t)||(t<b||t>f?m.setError(`quantity.${r.id}`,{type:"manual",message:a("orders.fulfillment.error.wrongQuantity",{count:f,number:f})}):m.clearErrors(`quantity.${r.id}`))}})}),e.jsx(l.ErrorMessage,{})]})})]})})]})}function W({order:r}){const{t:i}=I(),{handleSuccess:m}=V(),{mutateAsync:u,isPending:j}=T(r.id);L({region_id:r.region_id});const[a,d]=N.useState(()=>r.items.filter(s=>g(s)>0)),n=$({defaultValues:{quantity:a.reduce((s,t)=>(s[t.id]=g(t),s),{}),send_notification:!r.no_notification},resolver:z(D)}),{stock_locations:o=[]}=O(),_=n.handleSubmit(async s=>{try{await u({location_id:s.location_id,no_notification:!s.send_notification,items:Object.entries(s.quantity).filter(([,t])=>!!t).map(([t,c])=>({id:t,quantity:c}))}),w.success(i("orders.fulfillment.toast.created")),m(`/orders/${r.id}`)}catch(t){w.error(t.message)}});N.useEffect(()=>{o!=null&&o.length&&n.setValue("location_id",o[0].id)},[o==null?void 0:o.length]);const b=s=>{d(t=>t.filter(c=>c.id!==s)),n.unregister(`quantity.${s}`)},f=()=>{const s=r.items.filter(t=>g(t)>0);d(s),s.forEach(t=>n.register(`quantity.${t.id}`,{value:g(t)})),n.clearErrors("root")},x=Q({name:"location_id",control:n.control});return N.useEffect(()=>{a.length||n.setError("root",{type:"manual",message:i("orders.fulfillment.error.noItems")})},[a.length]),e.jsx(y.Form,{form:n,children:e.jsxs("form",{onSubmit:_,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(y.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(y.Close,{asChild:!0,children:e.jsx(F,{size:"small",variant:"secondary",children:i("actions.cancel")})}),e.jsx(F,{size:"small",type:"submit",isLoading:j,children:i("orders.fulfillment.create")})]})}),e.jsx(y.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l.Field,{control:n.control,name:"location_id",render:({field:{onChange:s,ref:t,...c}})=>e.jsxs(l.Item,{children:[e.jsx(l.Label,{children:i("fields.location")}),e.jsx(l.Hint,{children:i("orders.fulfillment.locationDescription")}),e.jsx(l.Control,{children:e.jsxs(v,{onValueChange:s,...c,children:[e.jsx(v.Trigger,{className:"bg-ui-bg-base",ref:t,children:e.jsx(v.Value,{})}),e.jsx(v.Content,{children:o.map(p=>e.jsx(v.Item,{value:p.id,children:p.name},p.id))})]})}),e.jsx(l.ErrorMessage,{})]})}),e.jsxs(l.Item,{className:"mt-8",children:[e.jsx(l.Label,{children:i("orders.fulfillment.itemsToFulfill")}),e.jsx(l.Hint,{children:i("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:a.map(s=>e.jsx(G,{form:n,item:s,onItemRemove:b,locationId:x,currencyCode:r.currency_code},s.id))})]}),n.formState.errors.root&&e.jsxs(B,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:[n.formState.errors.root.message,e.jsx(F,{variant:"transparent",size:"small",type:"button",onClick:f,children:i("actions.reset")})]})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(l.Field,{control:n.control,name:"send_notification",render:({field:{onChange:s,value:t,...c}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(l.Label,{children:i("orders.returns.sendNotification")}),e.jsx(l.Control,{children:e.jsx(l.Control,{children:e.jsx(P,{checked:!!t,onCheckedChange:s,...c})})})]}),e.jsx(l.Hint,{className:"!mt-1",children:i("orders.fulfillment.sendNotificationHint")}),e.jsx(l.ErrorMessage,{})]})})})]})})})})]})})}function pe(){const{id:r}=q(),{order:i,isLoading:m,isError:u,error:j}=M(r,{fields:"currency_code,*items,*items.variant,*shipping_address"});if(u)throw j;const a=!m&&i;return e.jsx(y,{children:a&&e.jsx(W,{order:i})})}export{pe as Component};
