import{c as R,u as S,b as I}from"./chunk-EUUYLNNT-DDR_xHro.js";import{i as T}from"./chunk-G2J2T2QU-B54yRBv6.js";import{w,d as N,j as m,u as O,r as D,t as x}from"./index-DQ7iaOIo.js";import{D as M}from"./chunk-FUHEDN6F-DJm8RBCj.js";import"./index.esm-C23H4hs_.js";import{u as F}from"./chunk-C7RYT3S3-DvWl1ixb.js";import{c as v}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{c as $,f as k}from"./chunk-MSD3WROE-DDuIqIqG.js";import{R as P,u as z}from"./chunk-RLLZZQKN-CuYY48Je.js";import{u as B}from"./chunk-4N7PLYUW-DRfoew5M.js";import{t as U}from"./zod-DqtdDTUb.js";import{z as A}from"./index-yuYasa5Y.js";import{B as j}from"./label-DsyTUQgE.js";import"./chunk-PHMALPVO-BXYfPvrg.js";import"./chunk-VZRDVNEY-twUt44Gw.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-QHCOJC4V-B0UJ2So3.js";import"./chunk-GH77ZQI2-CyzKiLW4.js";import"./index-DW7vLJga.js";import"./index-LtR7LJbL.js";import"./chunk-YVTBRLIE-QBelkXWc.js";import"./chunk-RYVWLLZ2-CmEHdxLZ.js";import"./prompt-BKfKBHyN.js";import"./chunk-DMYZ6SLX-CvGU_oYL.js";var G=A.object({products:R}),V=({priceList:o,products:l,regions:i,currencies:n,pricePreferences:c})=>{const{t:a}=O(),{handleSuccess:d,setCloseOnEscape:s}=z(),e=D.useRef(H(o,l)),t=F({defaultValues:{products:e.current},resolver:U(G)}),{mutateAsync:r,isPending:p}=k(o.id),u=t.handleSubmit(async f=>{const{products:g}=f,{pricesToDelete:y,pricesToCreate:b,pricesToUpdate:E}=q(g,e.current,i);r({delete:y,update:E,create:b},{onSuccess:()=>{x.success(a("priceLists.products.edit.successToast")),d()},onError:L=>{x.error(L.message)}})}),h=I({currencies:n,regions:i,pricePreferences:c});return m.jsx(P.Form,{form:t,children:m.jsxs("form",{onSubmit:u,className:"flex size-full flex-col",children:[m.jsx(P.Header,{}),m.jsx(P.Body,{className:"flex flex-col overflow-hidden",children:m.jsx(M,{columns:h,data:l,getSubRows:f=>{if(T(f)&&f.variants)return f.variants},state:t,onEditingChange:f=>s(!f)})}),m.jsx(P.Footer,{children:m.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[m.jsx(P.Close,{asChild:!0,children:m.jsx(j,{size:"small",variant:"secondary",children:a("actions.cancel")})}),m.jsx(j,{size:"small",type:"submit",isLoading:p,children:a("actions.save")})]})})]})})};function H(o,l){var c,a;const i={},n=(c=o.prices)==null?void 0:c.reduce((d,s)=>{var r;const e=d[s.variant_id]||{};if(!!((r=s.rules)!=null&&r.region_id)){const p=s.rules.region_id;e.region_prices={...e.region_prices,[p]:{amount:s.amount.toString(),id:s.id}}}else e.currency_prices={...e.currency_prices,[s.currency_code]:{amount:s.amount.toString(),id:s.id}};return d[s.variant_id]=e,d},{});for(const d of l)i[d.id]={variants:((a=d.variants)==null?void 0:a.reduce((s,e)=>{const t=n[e.id]||{};return s[e.id]=t,s},{}))||{}};return i}function _(o,l){const i=[],n=l.reduce((c,a)=>(c[a.id]=a.currency_code,c),{});for(const[c,a]of Object.entries(o||{})){const{variants:d}=a||{};for(const[s,e]of Object.entries(d||{})){const{currency_prices:t,region_prices:r}=e||{};for(const[p,u]of Object.entries(t||{}))u!=null&&u.amount&&i.push({variantId:s,currencyCode:p,amount:v(u.amount),id:u.id});for(const[p,u]of Object.entries(r||{}))u!=null&&u.amount&&i.push({variantId:s,regionId:p,currencyCode:n[p],amount:v(u.amount),id:u.id})}}return i}function C(o){return`${o.variantId}-${o.currencyCode}-${o.regionId||"none"}-${o.id||"none"}`}function K(o,l){const i=[],n=[],c=[],a=o.reduce((e,t)=>(e[C(t)]=t,e),{}),d=l.reduce((e,t)=>(e[C(t)]=t,e),{}),s=new Set([...Object.keys(a),...Object.keys(d)]);for(const e of s){const t=a[e],r=d[e];t&&r&&(isNaN(r.amount)&&r.id&&c.push(r.id),t.amount!==r.amount&&r.id&&i.push({id:r.id,variant_id:r.variantId,currency_code:r.currencyCode,rules:r.regionId?{region_id:r.regionId}:void 0,amount:r.amount})),!t&&r&&n.push({variant_id:r.variantId,currency_code:r.currencyCode,rules:r.regionId?{region_id:r.regionId}:void 0,amount:r.amount}),t&&!r&&t.id&&c.push(t.id)}return{pricesToDelete:c,pricesToCreate:n,pricesToUpdate:i}}function q(o,l,i){const n=_(l,i),c=_(o,i);return K(n,c)}var yr=()=>{const{id:o}=w(),[l]=N(),i=l.get("ids[]"),{price_list:n,isLoading:c,isError:a,error:d}=$(o),s=i==null?void 0:i.split(","),{products:e,isLoading:t,isError:r,error:p}=B({id:s,limit:(s==null?void 0:s.length)||9999,price_list_id:[o],fields:"title,thumbnail,*variants"}),{isReady:u,regions:h,currencies:f,pricePreferences:g}=S(),y=!c&&!!n&&!t&&!!e&&u;if(a)throw d;if(r)throw p;return m.jsxs(P,{children:[m.jsx(P.Title,{asChild:!0,children:m.jsxs("span",{className:"sr-only",children:["Edit Prices for ",n==null?void 0:n.title]})}),m.jsx(P.Description,{className:"sr-only",children:"Update prices for products in the price list"}),y&&m.jsx(V,{priceList:n,products:e,regions:h,currencies:f,pricePreferences:g})]})};export{yr as Component};
