import{P as Q,u as W,b as X}from"./chunk-EUUYLNNT-DDR_xHro.js";import{e as Z,i as J}from"./chunk-G2J2T2QU-B54yRBv6.js";import{u as U}from"./chunk-QBDU475K--UbpR47S.js";import{w as Y,j as e,r as C,u as G,t as N,k as ee,y as O}from"./index-DQ7iaOIo.js";import{u as re,a as te}from"./chunk-55F244YM-B_ivUNU-.js";import{D as se}from"./chunk-FUHEDN6F-DJm8RBCj.js";import"./index.esm-C23H4hs_.js";import{u as ie,a as F}from"./chunk-C7RYT3S3-DvWl1ixb.js";import{u as oe,D as ce}from"./chunk-MOFW5DA3-BBRzwwAr.js";import"./lodash-BbEdBw2P.js";import"./chunk-7LAPOKHJ-CJKFdgcT.js";import"./chunk-M566SHKI-CpCecA-q.js";import{u as H}from"./chunk-4N7PLYUW-DRfoew5M.js";import{c as ae,f as ne}from"./chunk-MSD3WROE-DDuIqIqG.js";import{R as S,u as K}from"./chunk-RLLZZQKN-CuYY48Je.js";import{t as de}from"./zod-DqtdDTUb.js";import{z as D}from"./index-yuYasa5Y.js";import{P as y}from"./progress-tabs-nihPaPnN.js";import{B as _}from"./label-DsyTUQgE.js";import{C as B}from"./checkbox-BXdKf1Kl.js";import{c as le}from"./index-DW7vLJga.js";import"./chunk-PHMALPVO-BXYfPvrg.js";import"./chunk-VZRDVNEY-twUt44Gw.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-QHCOJC4V-B0UJ2So3.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./chunk-6XHB4MRO-D_LOUyOE.js";import"./chunk-ADOCJB6L-DwJI6LYz.js";import"./chunk-P3UUX2T6-OlAXa1VC.js";import"./chunk-C76H5USB-BzcnRuay.js";import"./chunk-NGTKJO6Q-CBxZNPj4.js";import"./chunk-OPYB3EPU-Gu9ostxc.js";import"./chunk-AYIUW4A5-32QjTsWY.js";import"./chunk-GH77ZQI2-CyzKiLW4.js";import"./index-LtR7LJbL.js";import"./chunk-5FUV23JF-BunLQmqw.js";import"./chunk-RKBIB2RM-cgj6pqOB.js";import"./chunk-WX2SMNCD-CYp4yo3d.js";import"./plus-mini-DfhjBeEB.js";import"./command-bar-B4tNt0in.js";import"./index-T2cn0UOM.js";import"./chunk-QAF7PVQE-D70u5tsT.js";import"./format-CJ2FegFx.js";import"./_baseIsEqual-DdDy9tKi.js";import"./date-picker-BsdoIRhX.js";import"./clsx-B-dksMZM.js";import"./popover-C1ro1ubo.js";import"./x-mark-mini-DjxzaqmQ.js";import"./triangle-left-mini-o3U9ykef.js";import"./chunk-DMYZ6SLX-CvGU_oYL.js";import"./chunk-YVTBRLIE-QBelkXWc.js";import"./chunk-RYVWLLZ2-CmEHdxLZ.js";import"./prompt-BKfKBHyN.js";import"./index-CIxKSFC7.js";var ue=({form:i,currencies:t,regions:a,pricePreferences:p})=>{const o=F({control:i.control,name:"product_ids"}),m=F({control:i.control,name:"products"}),{products:l,isLoading:n,isError:f,error:h}=H({id:o.map(d=>d.id),limit:o.length,fields:"title,thumbnail,*variants"}),{setValue:u}=i,{setCloseOnEscape:T}=K();C.useEffect(()=>{!n&&l&&l.forEach(d=>{m[d.id]||!d.variants||u(`products.${d.id}.variants`,{...d.variants.reduce((j,w)=>(j[w.id]={currency_prices:{},region_prices:{}},j),{})})})},[l,m,n,u]);const b=X({currencies:t,regions:a,pricePreferences:p});if(f)throw h;return e.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:e.jsx(se,{columns:b,data:l,getSubRows:d=>{if(J(d)&&d.variants)return d.variants},state:i,onEditingChange:d=>T(!d)})})},I=50,M="p";function pe(i){return i.reduce((t,a)=>(t[a.id]=!0,t),{})}var me=({priceList:i,form:t})=>{const{control:a,setValue:p}=t,o=C.useMemo(()=>i.prices.reduce((r,c)=>(r[c.variant_id]=!0,r),{}),[i.prices]),m=F({control:a,name:"product_ids"}),l=F({control:a,name:"products"}),[n,f]=C.useState(pe(m)),{searchParams:h,raw:u}=re({pageSize:I,prefix:M}),{products:T,count:b,isLoading:d,isError:j,error:w}=H(h,{placeholderData:ee}),L=r=>{const c=typeof r=="function"?r(n):r,P=Object.keys(c),k=Object.keys(l).reduce((E,A)=>(P.includes(A)&&(E[A]=l[A]),E),{}),q=P.map(E=>({id:E}));p("product_ids",q,{shouldDirty:!0,shouldTouch:!0}),p("products",k,{shouldDirty:!0,shouldTouch:!0}),f(c)},R=he(),s=te(),{table:x}=oe({data:T||[],columns:R,count:b,enablePagination:!0,enableRowSelection:r=>{var c,P;return!!((c=r.original.variants)!=null&&c.length)&&!((P=r.original.variants)!=null&&P.some(v=>o[v.id]))},getRowId:r=>r.id,rowSelection:{state:n,updater:L},pageSize:I,meta:{variantIdMap:o}});if(j)throw w;return e.jsx("div",{className:"flex size-full flex-col",children:e.jsx(ce,{table:x,columns:R,filters:s,pageSize:I,prefix:M,count:b,isLoading:d,layout:"fill",orderBy:["title","status","created_at","updated_at"],pagination:!0,search:!0,queryObject:u})})},fe=le(),he=()=>{const i=U();return C.useMemo(()=>[fe.display({id:"select",header:({table:t})=>e.jsx(B,{checked:t.getIsSomePageRowsSelected()?"indeterminate":t.getIsAllPageRowsSelected(),onCheckedChange:a=>t.toggleAllPageRowsSelected(!!a)}),cell:({row:t,table:a})=>{var f;const{variantIdMap:p}=a.options.meta,o=(f=t.original.variants)==null?void 0:f.some(h=>p[h.id]),m=!t.getCanSelect()||o,l=t.getIsSelected()||o,n=e.jsx(B,{checked:l,disabled:m,onCheckedChange:h=>t.toggleSelected(!!h),onClick:h=>{h.stopPropagation()}});return o?e.jsx(O,{content:"This product is already in the price list",children:n}):m?e.jsx(O,{content:"This product has no variants",children:n}):n}}),...i],[i])},z=D.object({product_ids:D.array(D.object({id:D.string()})).min(1),products:Q}),$=z.pick({product_ids:!0}),V=Object.keys($.shape),xe=z.pick({products:!0}),Pe=Object.keys(xe.shape),g=["product","price"],ge={product:"in-progress",price:"not-started"},ve=({priceList:i,regions:t,currencies:a,pricePreferences:p})=>{const[o,m]=C.useState("product"),[l,n]=C.useState(ge),{t:f}=G(),{handleSuccess:h}=K(),u=ie({defaultValues:{products:{},product_ids:[]},resolver:de(z)}),{mutateAsync:T,isPending:b}=ne(i.id),d=u.handleSubmit(async s=>{const{products:x}=s,r=Z(x,t);await T({create:r},{onSuccess:()=>{N.success(f("priceLists.products.add.successToast")),h()},onError:c=>N.error(c.message)})}),j=(s,x)=>{u.clearErrors(s);const r=s.reduce((P,v)=>(P[v]=u.getValues(v),P),{}),c=x.safeParse(r);return c.success?!0:(c.error.errors.forEach(({path:P,message:v,code:k})=>{u.setError(P.join("."),{type:k,message:v})}),!1)},w=s=>{switch(s){case"product":return V.some(r=>u.getFieldState(r).isDirty);case"price":return Pe.some(r=>u.getFieldState(r).isDirty)}},L=s=>{if(o===s)return;if(g.indexOf(s)<g.indexOf(o)){const r=w(o);n(c=>({...c,[o]:r?c[o]:"not-started",[s]:"in-progress"})),m(s);return}const x=g.slice(0,g.indexOf(s));for(const r of x)if(r==="product"){if(!j(V,$)){n(c=>({...c,[r]:"in-progress"})),m(r);return}n(c=>({...c,[r]:"completed"}))}n(r=>({...r,[o]:"completed",[s]:"in-progress"})),m(s)},R=s=>{if(g.indexOf(s)+1>=g.length)return;const x=g[g.indexOf(s)+1];L(x)};return e.jsx(S.Form,{form:u,children:e.jsx(y,{value:o,onValueChange:s=>L(s),className:"flex h-full flex-col overflow-hidden",children:e.jsxs("form",{onSubmit:d,className:"flex h-full flex-col",children:[e.jsx(S.Header,{children:e.jsx("div",{className:"flex w-full items-center justify-between gap-x-4",children:e.jsx("div",{className:"-my-2 w-full max-w-[600px] border-l",children:e.jsxs(y.List,{className:"grid w-full grid-cols-3",children:[e.jsx(y.Trigger,{status:l.product,value:"product",children:f("priceLists.create.tabs.products")}),e.jsx(y.Trigger,{status:l.price,value:"price",children:f("priceLists.create.tabs.prices")})]})})})}),e.jsxs(S.Body,{className:"size-full overflow-hidden",children:[e.jsx(y.Content,{className:"size-full overflow-y-auto",value:"product",children:e.jsx(me,{form:u,priceList:i})}),e.jsx(y.Content,{className:"size-full overflow-hidden",value:"price",children:e.jsx(ue,{form:u,regions:t,currencies:a,pricePreferences:p})})]}),e.jsx(S.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(S.Close,{asChild:!0,children:e.jsx(_,{variant:"secondary",size:"small",children:f("actions.cancel")})}),e.jsx(be,{tab:o,next:R,isLoading:b})]})})]})})})},be=({tab:i,next:t,isLoading:a})=>{const{t:p}=G();return i==="price"?e.jsx(_,{type:"submit",variant:"primary",size:"small",isLoading:a,children:p("actions.save")},"submit-button"):e.jsx(_,{type:"button",variant:"primary",size:"small",onClick:()=>t(i),children:p("actions.continue")},"next-button")},jr=()=>{const{id:i}=Y(),{price_list:t,isPending:a,isError:p,error:o}=ae(i),{currencies:m,regions:l,pricePreferences:n,isReady:f}=W(),h=f&&!a&&!!t;if(p)throw o;return e.jsx(S,{children:h&&e.jsx(ve,{priceList:t,currencies:m,regions:l,pricePreferences:n})})};export{jr as Component};
