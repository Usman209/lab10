import{a as Z,b as J,c as M,d as K,e as X,f as Y,g as ee,h as te,i as re,j as se}from"./chunk-JCVALELX-CXrRyc-h.js";import{a as T}from"./chunk-FSMQADBD-DQ6u7KYm.js";import{T as ae}from"./chunk-PHMALPVO-BXYfPvrg.js";import{r as d,w as ie,u as D,b as ne,a3 as oe,c0 as le,t as f,j as e,H as ce,T as A,I as F}from"./index-DQ7iaOIo.js";import{u as de}from"./chunk-3UMDCRM2-NSGJIubw.js";import{a as N,u as ue}from"./chunk-RLLZZQKN-CuYY48Je.js";import{u as me,F as u}from"./chunk-C7RYT3S3-DvWl1ixb.js";import{t as fe}from"./zod-DqtdDTUb.js";import{z as j}from"./index-yuYasa5Y.js";import{A as he}from"./alert-BDVUsyGc.js";import{S as xe}from"./switch-CHhgpYt_.js";import{B as $}from"./label-DsyTUQgE.js";import{P as L}from"./popover-C1ro1ubo.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./prompt-BKfKBHyN.js";import"./x-mark-mini-DjxzaqmQ.js";import"./index-CIxKSFC7.js";import"./index-T2cn0UOM.js";var pe=Object.defineProperty,O=Object.getOwnPropertySymbols,B=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable,S=(t,r,s)=>r in t?pe(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,ye=(t,r)=>{for(var s in r||(r={}))B.call(r,s)&&S(t,s,r[s]);if(O)for(var s of O(r))H.call(r,s)&&S(t,s,r[s]);return t},_e=(t,r)=>{var s={};for(var a in t)B.call(t,a)&&r.indexOf(a)<0&&(s[a]=t[a]);if(t!=null&&O)for(var a of O(t))r.indexOf(a)<0&&H.call(t,a)&&(s[a]=t[a]);return s};const z=d.forwardRef((t,r)=>{var s=t,{color:a="currentColor"}=s,c=_e(s,["color"]);return d.createElement("svg",ye({xmlns:"http://www.w3.org/2000/svg",width:15,height:15,fill:"none",ref:r},c),d.createElement("path",{stroke:a,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M13.056 7.5H1.944M9.278 3.722 13.056 7.5l-3.778 3.778"}))});z.displayName="ArrrowRight";var ve=Object.defineProperty,I=Object.getOwnPropertySymbols,U=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable,V=(t,r,s)=>r in t?ve(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,ge=(t,r)=>{for(var s in r||(r={}))U.call(r,s)&&V(t,s,r[s]);if(I)for(var s of I(r))W.call(r,s)&&V(t,s,r[s]);return t},je=(t,r)=>{var s={};for(var a in t)U.call(t,a)&&r.indexOf(a)<0&&(s[a]=t[a]);if(t!=null&&I)for(var a of I(t))r.indexOf(a)<0&&W.call(t,a)&&(s[a]=t[a]);return s};const Q=d.forwardRef((t,r)=>{var s=t,{color:a="currentColor"}=s,c=je(s,["color"]);return d.createElement("svg",ge({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",ref:r},c),d.createElement("g",{id:"heart-broken"},d.createElement("path",{d:"M8.24998 3.47314L6.4722 5.72203L10.0278 7.49981L8.24998 9.27759",stroke:a,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5}),d.createElement("path",{d:"M7.83132 13.0306C8.09532 13.1683 8.40376 13.1683 8.66776 13.0306C10.0633 12.3026 14.4713 9.66434 14.4713 5.37456C14.4784 3.49011 12.9567 1.95589 11.0704 1.94434C9.93532 1.95856 8.88021 2.531 8.24998 3.47322C7.61887 2.531 6.56376 1.95856 5.42954 1.94434C3.54243 1.95589 2.02154 3.49011 2.02865 5.37456C2.02865 9.66434 6.43576 12.3026 7.83132 13.0306Z",stroke:a,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5})))});Q.displayName="HeartBroken";var be=j.object({items:j.array(j.object({quantity:j.number().nullable(),written_off_quantity:j.number().nullable(),item_id:j.string()})),send_notification:j.boolean().optional()});function we({form:t,item:r,index:s,returnId:a,orderId:c}){const{t:o}=D(),[b,R]=d.useState(!1),{mutateAsync:q}=te(a,c),{mutateAsync:C}=re(a,c),{mutateAsync:_}=se(a,c),v=async m=>{var g;const l=(g=r.actions)==null?void 0:g.find(x=>x.action==="RECEIVE_DAMAGED_RETURN_ITEM");if(typeof m=="number"&&m<0){t.setValue(`items.${s}.written_off_quantity`,r.detail.written_off_quantity,{shouldTouch:!0,shouldDirty:!0}),f.error(o("orders.returns.receive.toast.errorNegativeValue"));return}if(typeof m=="number"&&m>r.quantity-r.detail.return_received_quantity){t.setValue(`items.${s}.written_off_quantity`,r.detail.written_off_quantity,{shouldTouch:!0,shouldDirty:!0}),f.error(o("orders.returns.receive.toast.errorLargeDamagedValue"));return}try{m?l?await C({actionId:l.id,quantity:m}):await q({items:[{id:r.id,quantity:m}]}):l&&await _(l.id)}catch(x){f.error(x.message)}};return e.jsxs(L,{open:b,onOpenChange:R,children:[e.jsx(L.Trigger,{asChild:!0,children:e.jsxs($,{className:"flex gap-2 px-2",variant:"secondary",type:"button",children:[e.jsx("div",{children:e.jsx(Q,{})}),!!r.detail.written_off_quantity&&e.jsx("span",{children:r.detail.written_off_quantity})]})}),e.jsx(L.Content,{align:"center",children:e.jsxs("div",{className:"flex flex-col p-2",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle mb-2 font-medium",children:o("orders.returns.receive.writeOffInputLabel")}),e.jsx(u.Field,{control:t.control,name:`items.${s}.written_off_quantity`,render:({field:{onChange:m,value:l,...g}})=>e.jsx(u.Item,{className:"w-full",children:e.jsx(u.Control,{children:e.jsx(F,{min:0,max:r.quantity,type:"number",value:l,className:"bg-ui-bg-field-component text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",onChange:x=>{const k=x.target.value===""?null:parseFloat(x.target.value);m(k)},...g,onBlur:()=>{g.onBlur(),v(l)}})})})})]})})]})}var Ne=we;function Re({order:t,preview:r,orderReturn:s}){const{t:a}=D(),{handleSuccess:c}=ue(),o=d.useMemo(()=>{const n={};return s.items.forEach(i=>n[i.item_id]=!0),r.items.filter(i=>n[i.id])},[r.items,s]),{mutateAsync:b}=K(s.id,t.id),{mutateAsync:R}=X(s.id,t.id),{mutateAsync:q}=M(s.id,t.id),{mutateAsync:C}=Y(s.id,t.id),{mutateAsync:_}=ee(s.id,t.id),{stock_location:v}=de(s.location_id,void 0,{enabled:!!s.location_id}),m=d.useMemo(()=>{const n={};return t.items.forEach(i=>n[i.id]=i),n},[t.items]),l=me({defaultValues:{items:o==null?void 0:o.sort((n,i)=>n.id.localeCompare(i.id)).map(n=>({item_id:n.id,quantity:n.detail.return_received_quantity,written_off_quantity:n.detail.written_off_quantity})),send_notification:!1},resolver:fe(be)});d.useEffect(()=>{o==null||o.sort((n,i)=>n.id.localeCompare(i.id)).forEach((n,i)=>{l.setValue(`items.${i}.quantity`,n.detail.return_received_quantity,{shouldTouch:!0,shouldDirty:!0}),l.setValue(`items.${i}.written_off_quantity`,n.detail.written_off_quantity,{shouldTouch:!0,shouldDirty:!0})})},[o]);const g=l.handleSubmit(async n=>{try{await b({no_notification:!n.send_notification}),c(`/orders/${t.id}`),f.success(a("general.success"),{description:a("orders.returns.receive.toast.success"),dismissLabel:a("actions.close")})}catch(i){f.error(a("general.error"),{description:i.message,dismissLabel:a("actions.close")})}}),x=async(n,i,p)=>{var E;const h=o==null?void 0:o.find(y=>y.id===n),w=(E=h==null?void 0:h.actions)==null?void 0:E.find(y=>y.action==="RECEIVE_RETURN_ITEM");if(typeof i=="number"&&i<0){l.setValue(`items.${p}.quantity`,h.detail.return_received_quantity,{shouldTouch:!0,shouldDirty:!0}),f.error(a("orders.returns.receive.toast.errorNegativeValue"));return}if(typeof i=="number"&&i>h.quantity){l.setValue(`items.${p}.quantity`,h.detail.return_received_quantity,{shouldTouch:!0,shouldDirty:!0}),f.error(a("orders.returns.receive.toast.errorLargeValue"));return}try{if(w){if(i===null||i===0){await _(w.id);return}await C({actionId:w.id,quantity:i})}else typeof i=="number"&&i>0&&i<=h.quantity&&await q({items:[{id:h.id,quantity:i}]})}catch(y){f.error(y.message)}},k=async n=>{try{n||await R()}catch(i){f.error(i.message)}};return e.jsx(N.Form,{form:l,onClose:k,children:e.jsxs("form",{onSubmit:g,className:"flex size-full flex-col overflow-hidden",children:[e.jsxs(N.Body,{className:"flex size-full flex-col overflow-auto",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{children:v&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"text-ui-fg-subtle"})," ",e.jsx("span",{className:"text-ui-fg-base txt-small font-medium",children:v.name})]})}),e.jsx("span",{className:"text-ui-fg-muted txt-small text-right",children:a("orders.returns.receive.itemsLabel")})]}),o.map((n,i)=>{const p=m[n.id];return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest mt-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsxs(A,{size:"small",className:"text-ui-fg-subtle",children:[n.quantity,"x"]}),e.jsx(ae,{src:n.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(A,{className:"txt-small",as:"span",weight:"plus",children:[n.title," "]}),p.variant.sku&&e.jsxs("span",{children:["(",p.variant.sku,")"]})]}),e.jsx(A,{as:"div",className:"text-ui-fg-subtle txt-small",children:p.variant.product.title})]})]}),e.jsxs("div",{className:"flex flex-1 flex-row items-center gap-2",children:[e.jsx(Ne,{form:l,item:n,index:i,returnId:s.id,orderId:t.id}),e.jsx(u.Field,{control:l.control,name:`items.${i}.quantity`,render:({field:{onChange:h,value:w,...E}})=>e.jsx(u.Item,{className:"w-full",children:e.jsx(u.Control,{children:e.jsx(F,{min:0,max:n.quantity,type:"number",value:w,className:"bg-ui-bg-field-component text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",onChange:y=>{const G=y.target.value===""?null:parseFloat(y.target.value);h(G)},...E,onBlur:()=>{E.onBlur(),x(n.id,w,i)}})})})})]})]})},n.id)}),e.jsxs("div",{className:"my-6 border-b border-t border-dashed py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("fields.total")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:T(r.total,t.currency_code)})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:a("orders.returns.outstandingAmount")}),e.jsx("span",{className:"txt-small font-medium",children:T(r.summary.difference_sum||0,t.currency_code)})]})]}),e.jsx(he,{className:"rounded-xl",variant:"warning",children:a("orders.returns.receive.inventoryWarning")}),e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl p-3",children:e.jsx(u.Field,{control:l.control,name:"send_notification",render:({field:{onChange:n,value:i,...p}})=>e.jsxs(u.Item,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u.Control,{children:e.jsx(xe,{className:"mt-1 self-start",checked:!!i,onCheckedChange:n,...p})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(u.Label,{children:a("orders.returns.sendNotification")}),e.jsx(u.Hint,{className:"!mt-1",children:a("orders.returns.receive.sendNotificationHint")})]})]}),e.jsx(u.ErrorMessage,{})]})})})]}),e.jsx(N.Footer,{className:"overflow-hidden",children:e.jsxs("div",{className:"flex items-center gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx($,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx($,{size:"small",type:"submit",isLoading:!1,children:a("actions.save")})]})})]})})}var P=!1;function ze(){const{id:t,return_id:r}=ie(),{t:s}=D(),a=ne(),{order:c}=oe(t,{fields:"+currency_code,*items"}),{order:o}=le(t),{return:b}=Z(r,{fields:"*items.item,*items.item.variant,*items.item.variant.product"}),{mutateAsync:R}=J(r,t),{mutateAsync:q}=M(r,t);d.useEffect(()=>{(async function(){if(!(P||!o)){if(o.order_change){o.order_change.change_type!=="return_receive"&&(a(`/orders/${c.id}`,{replace:!0}),f.error(s("orders.returns.activeChangeError")));return}P=!0;try{const{return:_}=await R({});await q({items:_.items.map(v=>({id:v.item_id,quantity:v.quantity}))})}catch(_){f.error(_.message)}finally{P=!1}}})()},[o]);const C=c&&b&&o;return e.jsxs(N,{children:[e.jsx(N.Header,{children:e.jsx(ce,{children:s("orders.returns.receive.title",{returnId:r==null?void 0:r.slice(-7)})})}),C&&e.jsx(Re,{order:c,orderReturn:b,preview:o})]})}export{ze as Component};
